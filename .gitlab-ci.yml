# Include the security scanning pipeline
include:
  - local: '.gitlab/security-scan.yml'

# Global variables - Branch Protection Configuration
variables:
  # Security scan configuration - Always blocking for branch protection
  BLOCKING_MODE: "true"        # Must be true for branch protection to work
  SCAN_SEMGREP: "true"         # Enable Semgrep SAST scanning
  SCAN_TRIVY: "true"           # Enable Trivy vulnerability scanning
  SCAN_GITLEAKS: "true"        # Enable Gitleaks secret scanning
  
  # Branch protection settings
  ENFORCE_BRANCH_PROTECTION: "true"  # Enable GitLab branch protection enforcement
  
  # DefectDojo integration (configure these in GitLab CI/CD variables)
  DEFECTDOJO_URL: "https://c9d0c1530abe.ngrok-free.app"
  DEFECTDOJO_TOKEN: "d5ebd60db81a7f286e5953a95deafc4bf7c7459c"

# Enhanced stages for comprehensive security scanning with branch protection
stages:
  - security
  - security-gate
  - report

# Pipeline rules - Enhanced for branch protection
workflow:
  rules:
    # Always run on merge requests (required for protected branches)
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # Run on main branch pushes (should be restricted to merge only in GitLab settings)
    - if: $CI_COMMIT_BRANCH == "main"
      variables:
        BLOCKING_MODE: "true"  # Always block on main branch failures
    # Run on develop branch pushes
    - if: $CI_COMMIT_BRANCH == "develop" 
      variables:
        BLOCKING_MODE: "true"  # Always block on develop branch failures
    # Manual pipeline triggers
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "api"
    # Feature branch pushes (for development)
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH != "main" && $CI_COMMIT_BRANCH != "develop"
      variables:
        BLOCKING_MODE: "false"  # Non-blocking for feature branches

# Security Gate - Branch Protection Enforcer
security_gate:
  stage: security-gate
  image: alpine:latest
  before_script:
    - apk add --no-cache jq
  script:
    - echo "ğŸ›¡ï¸ SECURITY GATE - BRANCH PROTECTION ENFORCEMENT"
    - echo "Branch:" $CI_COMMIT_BRANCH "| Pipeline:" $CI_PIPELINE_ID "| Commit:" $CI_COMMIT_SHORT_SHA
    - echo ""
    - |
      # Analyze security scan results
      TOTAL_CRITICAL_ISSUES=0
      SCAN_FAILURES=0
      
      # Check Semgrep results
      if [ -f semgrep-report-projectname.sarif ]; then
        SEMGREP_ISSUES=$(jq '[.runs[].results[]] | length' semgrep-report-projectname.sarif 2>/dev/null || echo "0")
        echo "ğŸ” Semgrep SAST: $SEMGREP_ISSUES issues found"
        TOTAL_CRITICAL_ISSUES=$((TOTAL_CRITICAL_ISSUES + SEMGREP_ISSUES))
        if [ "$SEMGREP_ISSUES" -gt 0 ]; then SCAN_FAILURES=$((SCAN_FAILURES + 1)); fi
      else
        echo "âŒ Semgrep SARIF report not found"
        SCAN_FAILURES=$((SCAN_FAILURES + 1))
      fi
      
      # Check Trivy results
      if [ -f sca-report-projectname.sarif ]; then
        TRIVY_ISSUES=$(jq '[.runs[].results[]] | length' sca-report-projectname.sarif 2>/dev/null || echo "0")
        echo "ğŸ›¡ï¸ Trivy Dependencies: $TRIVY_ISSUES vulnerabilities found"
        TOTAL_CRITICAL_ISSUES=$((TOTAL_CRITICAL_ISSUES + TRIVY_ISSUES))
        if [ "$TRIVY_ISSUES" -gt 0 ]; then SCAN_FAILURES=$((SCAN_FAILURES + 1)); fi
      else
        echo "âŒ Trivy SARIF report not found"
        SCAN_FAILURES=$((SCAN_FAILURES + 1))
      fi
      
      # Check Gitleaks results
      if [ -f gitleaks-projectname.sarif ]; then
        GITLEAKS_ISSUES=$(jq '[.runs[].results[]] | length' gitleaks-projectname.sarif 2>/dev/null || echo "0")
        echo "ğŸ” Gitleaks Secrets: $GITLEAKS_ISSUES secrets found"
        TOTAL_CRITICAL_ISSUES=$((TOTAL_CRITICAL_ISSUES + GITLEAKS_ISSUES))
        if [ "$GITLEAKS_ISSUES" -gt 0 ]; then SCAN_FAILURES=$((SCAN_FAILURES + 1)); fi
      else
        echo "âŒ Gitleaks SARIF report not found"
        SCAN_FAILURES=$((SCAN_FAILURES + 1))
      fi
      
      echo ""
      echo "ğŸ“Š SECURITY GATE SUMMARY:"
      echo "â”œâ”€â”€ Total Security Issues: $TOTAL_CRITICAL_ISSUES"
      echo "â”œâ”€â”€ Failed Security Scans: $SCAN_FAILURES/3"
      echo "â””â”€â”€ DefectDojo Dashboard: $DEFECTDOJO_URL"
      echo ""
      
      # Branch protection logic
      if [ "$CI_COMMIT_BRANCH" = "main" ] || [ "$CI_COMMIT_BRANCH" = "develop" ]; then
        echo "ğŸ”’ PROTECTED BRANCH DETECTED: $CI_COMMIT_BRANCH"
        if [ "$TOTAL_CRITICAL_ISSUES" -gt 0 ] || [ "$SCAN_FAILURES" -gt 0 ]; then
          echo ""
          echo "ğŸš« BRANCH PROTECTION ACTIVATED"
          echo "âŒ Code push/merge REJECTED due to security issues"
          echo ""
          echo "ğŸ“‹ Required Actions:"
          echo "â”œâ”€â”€ Fix all security vulnerabilities"
          echo "â”œâ”€â”€ Remove hardcoded secrets"
          echo "â”œâ”€â”€ Update vulnerable dependencies"
          echo "â””â”€â”€ Re-run security scans"
          echo ""
          echo "ğŸ”— View detailed findings: $DEFECTDOJO_URL"
          exit 1
        else
          echo "âœ… SECURITY GATE PASSED - No issues detected"
          echo "âœ… Code push/merge APPROVED for protected branch"
        fi
      else
        echo "ğŸ”“ Feature branch: $CI_COMMIT_BRANCH (non-protected)"
        if [ "$TOTAL_CRITICAL_ISSUES" -gt 0 ]; then
          echo "âš ï¸  Security issues detected but allowing push to feature branch"
          echo "ğŸ”” Please fix issues before merging to main/develop"
        else
          echo "âœ… No security issues detected"
        fi
      fi
  dependencies:
    - semgrep
    - trivy
    - gitleaks
  rules:
    # Always run security gate for protected branches
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"
    # Run on merge requests targeting protected branches
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # Run on manual triggers
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "api"
  allow_failure: false  # This job MUST pass for branch protection

# Security Summary Job
security_summary:
  stage: report
  image: alpine:latest
  before_script:
    - apk add --no-cache jq curl
  script:
    - echo "=== SECURITY SCAN SUMMARY ==="
    - echo "Pipeline:" $CI_PIPELINE_ID "| Commit:" $CI_COMMIT_SHORT_SHA "| Branch:" $CI_COMMIT_BRANCH
    - echo "Blocking Mode:" $BLOCKING_MODE
    - echo ""
    - |
      # Download and analyze artifacts
      TOTAL_ISSUES=0
      
      # Check Semgrep results
      if [ -f semgrep-report-projectname.sarif ]; then
        SEMGREP_ISSUES=$(jq '[.runs[].results[]] | length' semgrep-report-projectname.sarif 2>/dev/null || echo "0")
        echo "ğŸ” Semgrep (SAST): $SEMGREP_ISSUES issues found"
        TOTAL_ISSUES=$((TOTAL_ISSUES + SEMGREP_ISSUES))
      fi
      
      # Check Trivy results  
      if [ -f sca-report-projectname.sarif ]; then
        TRIVY_ISSUES=$(jq '[.runs[].results[]] | length' sca-report-projectname.sarif 2>/dev/null || echo "0")
        echo "ğŸ›¡ï¸ Trivy (Dependencies): $TRIVY_ISSUES vulnerabilities found"
        TOTAL_ISSUES=$((TOTAL_ISSUES + TRIVY_ISSUES))
      fi
      
      # Check Gitleaks results
      if [ -f gitleaks-projectname.sarif ]; then
        GITLEAKS_ISSUES=$(jq '[.runs[].results[]] | length' gitleaks-projectname.sarif 2>/dev/null || echo "0")
        echo "ğŸ” Gitleaks (Secrets): $GITLEAKS_ISSUES secrets found"
        TOTAL_ISSUES=$((TOTAL_ISSUES + GITLEAKS_ISSUES))
      fi
      
      echo ""
      echo "ğŸ“Š Total Security Issues: $TOTAL_ISSUES"
      
      if [ "$TOTAL_ISSUES" -gt 0 ]; then
        echo "âŒ Security issues detected!"
        echo "ğŸ“‹ Check DefectDojo for detailed findings: $DEFECTDOJO_URL"
        if [ "$BLOCKING_MODE" = "true" ]; then
          echo "ğŸš« Pipeline blocked due to security issues"
        else
          echo "âš ï¸ Pipeline allowed to continue (non-blocking mode)"
        fi
      else
        echo "âœ… No security issues detected!"
      fi
  dependencies:
    - semgrep
    - trivy  
    - gitleaks
  when: always
  allow_failure: true
