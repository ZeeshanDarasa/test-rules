name: Security Scan Suite

on:
  pull_request:
  pull_request_target:
  merge_group:
  push:
    branches: [ main, develop ]
  repository_dispatch:
    types: [security-scan, security-suite]
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of scan to run'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - semgrep
        - trivy
        - gitleaks
      blocking:
        description: 'Block workflow on findings'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      actions: read
      pull-requests: write
    
    strategy:
      fail-fast: ${{ github.event.inputs.blocking != 'false' }}
      matrix:
        scanner: 
          - name: semgrep
            enabled: ${{ github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'semgrep' || github.event.inputs.scan_type == '' }}
          - name: trivy
            enabled: ${{ github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'trivy' || github.event.inputs.scan_type == '' }}
          - name: gitleaks
            enabled: ${{ github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'gitleaks' || github.event.inputs.scan_type == '' }}
    
    steps:
      - name: Checkout code
        if: matrix.scanner.enabled
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # Semgrep
      - name: Install Semgrep
        if: matrix.scanner.name == 'semgrep' && matrix.scanner.enabled
        run: pip install semgrep
      
      - name: Run Semgrep
        if: matrix.scanner.name == 'semgrep' && matrix.scanner.enabled
        run: |
          BLOCKING="${{ github.event.inputs.blocking || 'true' }}"
          
          if [ "$BLOCKING" = "true" ]; then
            semgrep --config=auto --sarif --output=semgrep.sarif --no-git-ignore --error --severity=ERROR .
          else
            semgrep --config=auto --sarif --output=semgrep.sarif --no-git-ignore . || true
          fi
      
      # Trivy
      - name: Run Trivy
        if: matrix.scanner.name == 'trivy' && matrix.scanner.enabled
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'vuln'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL'
          exit-code: ${{ github.event.inputs.blocking == 'false' && '0' || '1' }}
        env:
          TRIVY_OFFLINE_SCAN: false
          TRIVY_NO_PROGRESS: true
          TRIVY_SKIP_VERSION_CHECK: true
      
      # Gitleaks
      - name: Install Gitleaks
        if: matrix.scanner.name == 'gitleaks' && matrix.scanner.enabled
        run: |
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.0_linux_x64.tar.gz
          sudo mv gitleaks /usr/local/bin/
      
      - name: Run Gitleaks
        if: matrix.scanner.name == 'gitleaks' && matrix.scanner.enabled
        run: |
          BLOCKING="${{ github.event.inputs.blocking || 'true' }}"
          EXIT_CODE=$([ "$BLOCKING" = "true" ] && echo "1" || echo "0")
          
          gitleaks detect \
            --source=. \
            --report-format=sarif \
            --report-path=gitleaks-results.sarif \
            --exit-code=$EXIT_CODE \
            --verbose || [ "$BLOCKING" = "false" ]
      
      # Create empty SARIFs if needed
      - name: Create empty SARIF files
        if: always()
        run: |
          for scanner in semgrep trivy gitleaks; do
            if [ "${{ matrix.scanner.name }}" = "$scanner" ]; then
              case $scanner in
                semgrep)
                  [ ! -f semgrep.sarif ] && echo '{"$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","version":"2.1.0","runs":[{"tool":{"driver":{"name":"Semgrep"}},"results":[]}]}' > semgrep.sarif
                  ;;
                trivy)
                  [ ! -f trivy-results.sarif ] && echo '{"$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","version":"2.1.0","runs":[{"tool":{"driver":{"name":"Trivy"}},"results":[]}]}' > trivy-results.sarif
                  ;;
                gitleaks)
                  [ ! -f gitleaks-results.sarif ] && echo '{"$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","version":"2.1.0","runs":[{"tool":{"driver":{"name":"Gitleaks"}},"results":[]}]}' > gitleaks-results.sarif
                  ;;
              esac
            fi
          done
      
      # Upload to DefectDojo
      - name: Upload to DefectDojo
        if: always()
        run: |
          SCANNER="${{ matrix.scanner.name }}"
          
          case $SCANNER in
            semgrep)
              FILE="semgrep.sarif"
              SCAN_TYPE="Semgrep JSON Report"
              TITLE="Semgrep SAST"
              TAGS="semgrep,sast"
              ;;
            trivy)
              FILE="trivy-results.sarif"
              SCAN_TYPE="Trivy Scan"
              TITLE="Trivy Vulnerability"
              TAGS="trivy,vulnerability"
              ;;
            gitleaks)
              FILE="gitleaks-results.sarif"
              SCAN_TYPE="Gitleaks Scan"
              TITLE="Gitleaks Secret"
              TAGS="gitleaks,secrets"
              ;;
          esac
          
          if [ -f "$FILE" ]; then
            if [ -n "${{ secrets.DEFECTDOJO_URL }}" ] && [ -n "${{ secrets.DEFECTDOJO_TOKEN }}" ]; then
              echo "Uploading results to DefectDojo..."
              # Debug URL
              DEFECTDOJO_URL="${{ secrets.DEFECTDOJO_URL }}"
              echo "Debug: DefectDojo URL = '$DEFECTDOJO_URL'"
              echo "Debug: URL length = ${#DEFECTDOJO_URL}"
              
              # Clean URL (remove any whitespace)
              DEFECTDOJO_URL=$(echo "$DEFECTDOJO_URL" | tr -d '[:space:]')
              echo "Debug: Cleaned URL = '$DEFECTDOJO_URL'"
              
              # Set variables
              PRODUCT_NAME="github"
              RANDOM_SUFFIX=$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 6 | head -n 1)
              ENGAGEMENT_NAME="Security Scan - $(date +%Y-%m-%d)-${RANDOM_SUFFIX}"
              
              # Step 1: Create/Get Product
              echo "Creating/Getting product: $PRODUCT_NAME"
              PRODUCT_RESPONSE=$(curl -s -X GET "${DEFECTDOJO_URL}/api/v2/products/?name=${PRODUCT_NAME}" \
                -H "Authorization: Token ${{ secrets.DEFECTDOJO_TOKEN }}")
              
              PRODUCT_COUNT=$(echo "$PRODUCT_RESPONSE" | jq -r '.count // 0')
              
              if [ "$PRODUCT_COUNT" -eq 0 ]; then
                echo "Product doesn't exist, creating it..."
                curl -s -X POST "${DEFECTDOJO_URL}/api/v2/products/" \
                  -H "Authorization: Token ${{ secrets.DEFECTDOJO_TOKEN }}" \
                  -H "Content-Type: application/json" \
                  -d "{\"name\":\"${PRODUCT_NAME}\",\"description\":\"GitHub Security Scans\",\"prod_type\":1}" > /dev/null
                echo "Product created successfully"
              else
                echo "Product already exists"
              fi
              
              # Get Product ID
              PRODUCT_ID=$(curl -s -X GET "${DEFECTDOJO_URL}/api/v2/products/?name=${PRODUCT_NAME}" \
                -H "Authorization: Token ${{ secrets.DEFECTDOJO_TOKEN }}" | jq -r '.results[0].id')
              
              # Step 2: Create/Get Engagement
              echo "Creating/Getting engagement: $ENGAGEMENT_NAME"
              ENGAGEMENT_RESPONSE=$(curl -s -X GET "${DEFECTDOJO_URL}/api/v2/engagements/?name=${ENGAGEMENT_NAME}&product=${PRODUCT_ID}" \
                -H "Authorization: Token ${{ secrets.DEFECTDOJO_TOKEN }}")
              
              ENGAGEMENT_COUNT=$(echo "$ENGAGEMENT_RESPONSE" | jq -r '.count // 0')
              
              if [ "$ENGAGEMENT_COUNT" -eq 0 ]; then
                echo "Engagement doesn't exist, creating it..."
                curl -s -X POST "${DEFECTDOJO_URL}/api/v2/engagements/" \
                  -H "Authorization: Token ${{ secrets.DEFECTDOJO_TOKEN }}" \
                  -H "Content-Type: application/json" \
                  -d "{\"name\":\"${ENGAGEMENT_NAME}\",\"product\":${PRODUCT_ID},\"target_start\":\"$(date +%Y-%m-%d)\",\"target_end\":\"$(date -d '+30 days' +%Y-%m-%d)\"}" > /dev/null
                echo "Engagement created successfully"
              else
                echo "Engagement already exists"
              fi
              
              # Step 3: Upload Scan Results
              echo "Uploading scan results..."
              curl -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
                -H "Authorization: Token ${{ secrets.DEFECTDOJO_TOKEN }}" \
                -F "scan_type=$SCAN_TYPE" \
                -F "file=@$FILE" \
                -F "product_name=${PRODUCT_NAME}" \
                -F "engagement_name=${ENGAGEMENT_NAME}" \
                -F "test_title=$TITLE - ${{ github.sha }}" \
                -F "active=true" \
                -F "verified=false" \
                -F "scan_date=$(date +%Y-%m-%d)" \
                -F "tags=$TAGS,automated,github" || echo "DefectDojo upload failed"
              
              echo "DefectDojo upload completed"
            else
              echo "DefectDojo secrets not configured - skipping upload"
            fi
          fi
      
      # Display results
      - name: Display results
        if: always()
        run: |
          SCANNER="${{ matrix.scanner.name }}"
          BLOCKING="${{ github.event.inputs.blocking || 'true' }}"
          
          echo "Scanner: $SCANNER"
          echo "Mode: $([ "$BLOCKING" = "true" ] && echo "BLOCKING" || echo "NON-BLOCKING")"
          
          case $SCANNER in
            semgrep)
              if [ -f semgrep.sarif ]; then
                FINDINGS=$(jq '[.runs[].results[]] | length' semgrep.sarif 2>/dev/null || echo "0")
                echo "Semgrep: $FINDINGS findings"
              fi
              ;;
            trivy)
              if [ -f trivy-results.sarif ]; then
                FINDINGS=$(jq '[.runs[].results[]] | length' trivy-results.sarif 2>/dev/null || echo "0")
                echo "Trivy: $FINDINGS findings"
              fi
              ;;
            gitleaks)
              if [ -f gitleaks-results.sarif ]; then
                FINDINGS=$(jq '[.runs[].results[]] | length' gitleaks-results.sarif 2>/dev/null || echo "0")
                echo "Gitleaks: $FINDINGS findings"
              fi
              ;;
          esac
      
      # Archive results
      - name: Upload SARIF artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.scanner.name }}-sarif
          path: "*.sarif"
          retention-days: 30

  # Summary job
  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: security-scan
    if: always()
    
    permissions:
      pull-requests: write
      
    steps:
      - name: Create summary comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const result = '${{ needs.security-scan.result }}';
            const blocking = '${{ github.event.inputs.blocking || 'true' }}' === 'true';
            
            let summary = '## 🔒 Security Scan Suite Results\n\n';
            summary += `**Mode**: ${blocking ? '🚫 Blocking' : '⚠️ Non-blocking'}\n`;
            summary += `**Status**: ${result === 'success' ? '✅ Passed' : '❌ Failed'}\n\n`;
            
            if (result !== 'success') {
              summary += blocking ? 
                '❌ **Security issues found - merge blocked until resolved**\n\n' :
                '⚠️ **Security issues found - review recommended**\n\n';
            } else {
              summary += '✅ **No critical security issues detected**\n\n';
            }
            
            summary += 'View detailed results in individual workflow runs above.';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });